{"version":3,"file":"bundle.js","sources":["../src/bundle.ts"],"sourcesContent":["import { join, resolve, dirname } from 'path';\n\nimport { rip } from './rip';\nimport { build } from 'esbuild';\nimport { pathStats } from './path_stats';\nimport { isProduction } from './is_production';\nimport { makeDirectories } from './mkdir';\nimport { SCRIPTS_LINK_REGEXP } from './constants';\nimport { ScriptsPluginOptions } from './types';\nimport { done, oops, start, bold } from './pretty';\n\ntype BundleOptions = Required<Omit<ScriptsPluginOptions, 'addWatchTarget'>>;\n\nconst findAndProcessFiles = (\n  html: string,\n  outputPath: string,\n  { inputDirectory, esbuildOptions, publicDirectory }: BundleOptions\n) => {\n  const [buildDirectory, ...nestedHTMLPath] = pathStats(outputPath).directories;\n\n  return rip(html, SCRIPTS_LINK_REGEXP).map(\n    async (publicSourcePathToScript) => {\n      start(`Start compiling \"${bold(publicSourcePathToScript)}\" file.`);\n\n      const absolutePathToScript = resolve(\n        inputDirectory,\n        publicSourcePathToScript\n      );\n      const publicOutputPathToScript = join(\n        publicDirectory,\n        publicSourcePathToScript.replace(/ts$/, 'js')\n      );\n\n      return makeDirectories(\n        dirname(resolve(buildDirectory, publicOutputPathToScript))\n      )\n        .then(() =>\n          build({\n            bundle: true,\n            target: 'es2017',\n            minify: isProduction(),\n            outfile: resolve(buildDirectory, publicOutputPathToScript),\n            sourcemap: !isProduction(),\n            entryPoints: [absolutePathToScript],\n            ...esbuildOptions,\n          })\n        )\n        .then(() =>\n          done(\n            `Compiled \"${bold(\n              publicSourcePathToScript\n            )}\" script was written to \"${bold(\n              join(buildDirectory, publicOutputPathToScript)\n            )}\"`\n          )\n        )\n        .then(() => ({\n          input: publicSourcePathToScript,\n          output: join(\n            ...nestedHTMLPath.map(() => '..'),\n            publicOutputPathToScript\n          ),\n        }));\n    }\n  );\n};\n\n/** Compile, bundle and minify script. */\nexport const bundle = async (\n  html: string,\n  outputPath: string,\n  options: BundleOptions\n) =>\n  Promise.all(findAndProcessFiles(html, outputPath, options))\n    .then((array) => array.filter(Boolean))\n    .then(\n      (validUrls) => {\n        const htmlWithScripts = validUrls.reduce(\n          (text, { input, output }) => text.replace(input, output),\n          html\n        );\n\n        if (validUrls.length > 0) {\n          done(\n            `${validUrls\n              .map(({ output }) => `\"${bold(output)}\"`)\n              .join(', ')} URL${\n              validUrls.length === 1 ? ' was' : 's were'\n            } injected into \"${bold(outputPath)}\"`\n          );\n        }\n\n        return htmlWithScripts;\n      },\n      (error) => (oops(error), html)\n    );\n"],"names":["async","html","outputPath","options","Promise","all","inputDirectory","esbuildOptions","publicDirectory","buildDirectory","nestedHTMLPath","pathStats","directories","rip","SCRIPTS_LINK_REGEXP","map","publicSourcePathToScript","start","bold","absolutePathToScript","resolve","publicOutputPathToScript","join","replace","makeDirectories","dirname","then","build","bundle","target","minify","isProduction","outfile","sourcemap","entryPoints","done","input","output","findAndProcessFiles","array","filter","Boolean","validUrls","htmlWithScripts","reduce","text","length","error","oops"],"mappings":"8RAoEsBA,MACpBC,EACAC,EACAC,IAEAC,QAAQC,IA5DkB,EAC1BJ,EACAC,GACEI,eAAAA,EAAgBC,eAAAA,EAAgBC,gBAAAA,MAElC,MAAOC,KAAmBC,GAAkBC,YAAUT,GAAYU,YAElE,OAAOC,MAAIZ,EAAMa,uBAAqBC,KACpCf,MAAOgB,IACLC,QAAM,oBAAoBC,OAAKF,aAE/B,MAAMG,EAAuBC,UAC3Bd,EACAU,GAEIK,EAA2BC,OAC/Bd,EACAQ,EAAyBO,QAAQ,MAAO,OAG1C,OAAOC,kBACLC,UAAQL,UAAQX,EAAgBY,KAE/BK,MAAK,IACJC,uBACEC,QAAQ,EACRC,OAAQ,SACRC,OAAQC,iBACRC,QAASZ,UAAQX,EAAgBY,GACjCY,WAAYF,iBACZG,YAAa,CAACf,IACXZ,MAGNmB,MAAK,IACJS,OACE,aAAajB,OACXF,8BAC2BE,OAC3BI,OAAKb,EAAgBY,UAI1BK,MAAK,MACJU,MAAOpB,EACPqB,OAAQf,UACHZ,EAAeK,KAAI,IAAM,OAC5BM,WAaEiB,CAAoBrC,EAAMC,EAAYC,IAC/CuB,MAAMa,GAAUA,EAAMC,OAAOC,WAC7Bf,MACEgB,IACC,MAAMC,EAAkBD,EAAUE,QAChC,CAACC,GAAQT,MAAAA,EAAOC,OAAAA,KAAaQ,EAAKtB,QAAQa,EAAOC,IACjDpC,GAaF,OAVIyC,EAAUI,OAAS,GACrBX,OACE,GAAGO,EACA3B,KAAI,EAAGsB,OAAAA,KAAa,IAAInB,OAAKmB,QAC7Bf,KAAK,YACe,IAArBoB,EAAUI,OAAe,OAAS,2BACjB5B,OAAKhB,OAIrByC,KAERI,IAAWC,OAAKD,GAAQ9C"}